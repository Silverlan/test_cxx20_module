name: CMake build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2







      - name: Install prerequisites
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends software-properties-common ca-certificates gnupg lsb-release curl

      - name: Add ubuntu-toolchain-r/test PPA and update apt
        run: |
          set -eux
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update

      - name: Show candidate packages (debug)
        run: |
          set -eux
          echo "lsb_release -a:"
          lsb_release -a || true
          apt-cache policy gcc-16 || true
          apt-cache madison gcc-16 || true

      - name: Install GCC 16 (gcc-16, g++-16)
        run: |
          set -eux
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get install -y --no-install-recommends gcc-16 g++-16 gfortran-16 || (apt-cache policy gcc-16 && exit 1)

      - name: Register with update-alternatives (optional)
        run: |
          set -eux
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-16 60 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-16
          sudo update-alternatives --set gcc /usr/bin/gcc-16
          sudo update-alternatives --set g++ /usr/bin/g++-16

      - name: Verify active GCC
        run: |
          gcc --version
          g++ --version














      - name: Install Dependencies
        shell: bash
        run: |
          sudo apt install clang
          sudo apt install ninja-build

      - name: Download Clang-22
        shell: bash
        run: |
          ARCHIVE_URL="https://github.com/Silverlan/clang_prebuilt/releases/download/2025-11-16/linux_x64.tar.xz"

          DEST_DIR="clang"
          mkdir -p "$DEST_DIR"

          curl -L -o /tmp/archive.tar.xz "$ARCHIVE_URL"
          tar -xJf /tmp/archive.tar.xz -C "$DEST_DIR" --strip-components=1

      - name: Download and extract gcc-15
        shell: bash
        run: |
          ARCHIVE_URL="https://github.com/Silverlan/test_gcc15/releases/download/2025-11-17/gcc-15.2.0.tar.xz"

          DEST_DIR="gcc-15"
          mkdir -p "$DEST_DIR"
          curl -L -o /tmp/archive.tar.xz "$ARCHIVE_URL"
          tar -xJf /tmp/archive.tar.xz -C "$DEST_DIR" --strip-components=1

      - name: Configure and build with CMake
        shell: bash
        run: |
          curDir="$PWD"
          mkdir -p build
          export CC="$PWD/clang/bin/clang"
          export CXX="$PWD/clang/bin/clang++"
          # -DCMAKE_CXX_STDLIB_MODULES_JSON="$curDir/gcc-15/lib64/libstdc++.modules.json"
          cmake -S . -B build -G "Ninja Multi-Config" \
            -DCMAKE_CXX_SCAN_FOR_MODULES=ON \
            -DCMAKE_CXX_COMPILER="$curDir/clang/bin/clang++"
          cmake --build build --target math
