name: CMake build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2







      # 1) Install Homebrew (Linux) non-interactively
      - name: Install Homebrew (Linux)
        run: |
          set -euo pipefail
          # Install Homebrew (official script)
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
          # Add Homebrew to PATH for the rest of this job
          echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
          echo "/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH
          # Recommended: disable brew auto-update inside CI run for speed (optional)
          echo "HOMEBREW_NO_AUTO_UPDATE=1" >> $GITHUB_ENV

      - name: Verify brew
        run: |
          brew --version
          brew config

      # Optional: use a Homebrew-specific installer + cache action (speeds repeated runs)
      # (Alternative: omit and run 'brew install gcc' directly.)
      - name: Install & cache Homebrew packages (optional)
        uses: gerlero/brew-install@v1
        with:
          packages: gcc
          cache: true

      # If you prefer to install directly (without the wrapper action), use:
      # - name: Install GCC (direct)
      #   run: brew install gcc

      # 2) If you used gerlero/brew-install above, 'gcc' should be present. Otherwise:
      - name: Ensure GCC is installed (fallback)
        if: ${{ always() }}
        run: |
          if ! command -v gcc-15 >/dev/null 2>&1; then
            brew update || true
            brew install gcc
          fi

      # 3) Set CC/CXX so subsequent steps use brewed gcc-15/g++-15
      - name: Export CC/CXX for job
        run: |
          echo "CC=$(which gcc-15)" >> $GITHUB_ENV
          echo "CXX=$(which g++-15)" >> $GITHUB_ENV
          # optional: expose full path to the brewed bin dir (useful for some tools)
          echo "HOMEBREW_BIN=$(brew --prefix)/bin" >> $GITHUB_ENV

      - name: Check GCC version
        run: |
          gcc-15 --version
          g++-15 --version











      - name: Install Dependencies
        shell: bash
        run: |
          sudo apt install clang
          sudo apt install ninja-build

      - name: Download Clang-22
        shell: bash
        run: |
          ARCHIVE_URL="https://github.com/Silverlan/clang_prebuilt/releases/download/2025-11-16/linux_x64.tar.xz"

          DEST_DIR="clang"
          mkdir -p "$DEST_DIR"

          curl -L -o /tmp/archive.tar.xz "$ARCHIVE_URL"
          tar -xJf /tmp/archive.tar.xz -C "$DEST_DIR" --strip-components=1

      #- name: Download and extract gcc-15
      #  shell: bash
      #  run: |
      #    ARCHIVE_URL="https://github.com/Silverlan/test_gcc15/releases/download/2025-11-17/gcc-15.2.0.tar.xz"

      #    DEST_DIR="gcc-15"
      #    mkdir -p "$DEST_DIR"
      #    curl -L -o /tmp/archive.tar.xz "$ARCHIVE_URL"
      #    tar -xJf /tmp/archive.tar.xz -C "$DEST_DIR" --strip-components=1

      #- name: Configure and build with CMake
      #  shell: bash
      #  run: |
      #    curDir="$PWD"
      #    mkdir -p build
      #    export CC="$PWD/clang/bin/clang"
      #    export CXX="$PWD/clang/bin/clang++"
      #    cmake -S . -B build -G "Ninja Multi-Config" \
      #      -DCMAKE_CXX_STDLIB_MODULES_JSON="/home/linuxbrew/.linuxbrew/Cellar/gcc/15.2.0/lib/gcc/current/libstdc++.modules.json" \
      #      -DCMAKE_CXX_FLAGS="--gcc-toolchain=/home/linuxbrew/.linuxbrew/Cellar/gcc/15.2.0" \
      #      -DCMAKE_CXX_SCAN_FOR_MODULES=ON \
      #      -DCMAKE_CXX_COMPILER="$curDir/clang/bin/clang++"
      #    cmake --build build --target math

      - name: Configure and build with CMake
        shell: bash
        run: |
          set -euo pipefail
          curDir="$PWD"

          # HOME for brewed gcc: adjust if you install different version, or compute dynamically
          GCC_BASE="/home/linuxbrew/.linuxbrew/Cellar/gcc/15.2.0"
          GCC_MAJOR="15"

          # canonical include/lib locations inside the brew gcc install
          GCC_INCLUDE="$GCC_BASE/include/c++/$GCC_MAJOR"
          # the include directory has a target-specific subdir like x86_64-pc-linux-gnu
          GCC_INCLUDE_TARGET="$(ls -1 "$GCC_INCLUDE" | head -n1)"
          GCC_INCLUDE_TARGET_FULL="$GCC_INCLUDE/$GCC_INCLUDE_TARGET"
          GCC_LIB="$GCC_BASE/lib/gcc/$GCC_MAJOR"

          echo "Using GCC_BASE=$GCC_BASE"
          echo "GCC_INCLUDE=$GCC_INCLUDE"
          echo "GCC_INCLUDE_TARGET_FULL=$GCC_INCLUDE_TARGET_FULL"
          echo "GCC_LIB=$GCC_LIB"

          # Export env vars so clang driver finds startup objects (crtbeginS.o etc.)
          # and so runtime/linker can find brewed libstdc++.
          export CPATH="$GCC_INCLUDE:$GCC_INCLUDE_TARGET_FULL:$CPATH"
          export CPLUS_INCLUDE_PATH="$GCC_INCLUDE:$GCC_INCLUDE_TARGET_FULL:$CPLUS_INCLUDE_PATH"
          export LIBRARY_PATH="$GCC_LIB:$LIBRARY_PATH"           # used by driver to find crt*.o
          export LD_LIBRARY_PATH="$GCC_LIB:$LD_LIBRARY_PATH"     # runtime (runnable in CI)
          export PKG_CONFIG_PATH="$GCC_BASE/lib/pkgconfig:$PKG_CONFIG_PATH" || true

          # Optional: show what compiler will see (for debugging)
          echo "CPATH=$CPATH"
          echo "LIBRARY_PATH=$LIBRARY_PATH"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"

          # Configure CMake: pass --gcc-toolchain and explicit include/linker hints.
          mkdir -p build
          export CC="$curDir/clang/bin/clang"
          export CXX="$curDir/clang/bin/clang++"

          cmake -S . -B build -G "Ninja Multi-Config" \
            -DCMAKE_C_COMPILER="$CC" \
            -DCMAKE_CXX_COMPILER="$CXX" \
            -DCMAKE_CXX_STDLIB_MODULES_JSON="$GCC_BASE/lib/gcc/current/libstdc++.modules.json" \
            -DCMAKE_CXX_FLAGS="--gcc-toolchain=$GCC_BASE -isystem $GCC_INCLUDE -isystem $GCC_INCLUDE_TARGET_FULL -B$GCC_LIB" \
            -DCMAKE_EXE_LINKER_FLAGS="-L$GCC_LIB -Wl,-rpath,$GCC_LIB" \
            -DCMAKE_SHARED_LINKER_FLAGS="-L$GCC_LIB -Wl,-rpath,$GCC_LIB" \
            -DCMAKE_CXX_SCAN_FOR_MODULES=ON

          cmake --build build --config Debug --target math
